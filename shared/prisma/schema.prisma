// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Ticket Management
model Ticket {
  id            String   @id @default(uuid())
  ticketNumber  Int      @unique @default(autoincrement()) // Auto-incrementing numerical ticket ID for display
  ticketThreadId String  @unique // Discord thread/channel ID
  guildId       String
  type          TicketType
  status        TicketStatus
  title         String

  // Opener
  openedById    String   // MemberRecord ID who created ticket
  openedBy      MemberRecord @relation("TicketOpener", fields: [openedById], references: [id], onDelete: Restrict)

  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  closedAt      DateTime?
  closedBy      String?  // Discord user ID
  closeReason   String?

  // Relations
  messages      TicketMessage[]
  logs          TicketLog[]
  assignments   TicketAssignment[]
  staffParticipants TicketStaffParticipation[]
  memberParticipants TicketMemberParticipation[]
  verification  VerificationTicket?
  eventReport   EventReportTicket?
  staffTalk     StaffTalkTicket?

  @@index([guildId, status])
  @@index([openedById])
}

enum TicketType {
  VERIFICATION_ID      // Only ID verification uses tickets
  STAFF_TALK
  EVENT_REPORT
  UNSOLICITED_DM
  FRIEND_REQUEST
  DRAMA
  OTHER
  // Note: VRChat verification is handled by Hephia Bot automatically, no ticket needed
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  AWAITING_RESPONSE
  CLOSED
  ARCHIVED
}

// Ticket Messages (for history/transcript)
model TicketMessage {
  id          String   @id @default(uuid())
  ticketId    String
  messageId   String   @unique // Discord message ID
  authorId    String   // Discord user ID
  content     String   @db.Text
  attachments Json     @default("[]") // Array of attachment URLs stored as JSON
  createdAt   DateTime

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([authorId])
}

// Ticket Activity Log
model TicketLog {
  id          String   @id @default(uuid())
  ticketId    String
  action      String   // "created", "assigned", "closed", "renamed", "user_added", "user_removed"
  staffId     String   // Discord user ID who performed action
  details     Json?    // Additional action details
  createdAt   DateTime @default(now())

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([staffId])
}

// Staff Assignments (tracking who's working on what)
model TicketAssignment {
  id          String   @id @default(uuid())
  ticketId    String
  staffId     String   // Discord user ID
  assignedAt  DateTime @default(now())
  unassignedAt DateTime?

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([staffId])
}

// Staff Participation (tracks all staff who participated in any capacity on a ticket)
// This will be populated by the Discord bot when staff interact with tickets
model TicketStaffParticipation {
  id          String   @id @default(uuid())
  ticketId    String
  staffId     String   // Discord user ID
  participationType String // "assigned", "message", "closed", "action", etc.
  participatedAt DateTime @default(now())
  metadata    Json?    // Additional context (message count, action type, etc.)

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([staffId])
  @@index([participationType])
  @@index([participatedAt])
}

// Member Participation (tracks regular members who participated in tickets, besides the opener)
// This will be populated by the Discord bot when members are added to tickets
model TicketMemberParticipation {
  id          String   @id @default(uuid())
  ticketId    String
  memberId    String   // MemberRecord ID
  member      MemberRecord @relation(fields: [memberId], references: [id], onDelete: Cascade)
  participationType String // "added", "message", "removed", etc.
  participatedAt DateTime @default(now())
  metadata    Json?    // Additional context (message count, etc.)

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([memberId])
  @@index([participationType])
  @@index([participatedAt])
}

// Member Records (for GitHub-style tracking)
model MemberRecord {
  id          String   @id @default(uuid())
  discordId   String   @unique
  discordTag  String
  displayName String?  // Display name (may differ from username)
  avatarUrl   String?
  bannerUrl   String?
  accentColor Int?     // Stored as integer (0xRRGGBB format)

  // Relations
  warnings    Warning[]
  moderationActions ModerationAction[]
  userPreferences UserPreferences?
  openedTickets Ticket[] @relation("TicketOpener")
  ticketMemberParticipations TicketMemberParticipation[]
  initialVerifications VerificationTicket[] @relation("InitialVerifier")
  finalVerifications VerificationTicket[] @relation("FinalVerifier")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// User Preferences (dashboard settings per user)
model UserPreferences {
  id          String   @id @default(uuid())
  discordId   String   @unique // Discord user ID
  dateFormat  String   @default("absolute") // "absolute" or "relative"
  
  // Relations
  member      MemberRecord @relation(fields: [discordId], references: [discordId], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Warnings/Punishments (for GitHub records integration)
model Warning {
  id          String   @id @default(uuid())
  memberId    String
  ticketId    String?  // Link to related ticket

  // Warning type
  type        WarningType

  // Warning details
  when        DateTime
  why         String   // Rule broken / reason
  result      String   // "Warning issued", "Timeout Xh", "Ban vote opened", etc.
  loggedBy    String   // Discord user ID of staff who logged

  // Evidence
  evidenceUrls Json     @default("[]") // Screenshot/evidence links stored as JSON

  // Status
  isActive    Boolean  @default(true) // Active for 1 week (for warnings)
  activeUntil DateTime?

  // Additional notes
  notes       String?  @db.Text // Additional context or notes

  // Relations
  member      MemberRecord @relation(fields: [memberId], references: [id], onDelete: Cascade)
  moderationAction ModerationAction?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([memberId])
  @@index([isActive])
  @@index([type])
  @@index([when])
}

enum WarningType {
  WARNING          // Formal warning
  INFORMAL_WARNING // Informal warning
  WATCHLIST        // Added to watchlist
  BANNED           // Member was banned
}

// Moderation Actions Log (tracks all moderation actions taken by staff)
model ModerationAction {
  id          String   @id @default(uuid())
  memberId    String   // Discord user ID of member action was taken on
  staffId     String   // Discord user ID of staff who took action
  ticketId    String?  // Link to related ticket (if applicable)
  warningId   String?  @unique // Link to warning record (if applicable)

  // Action details
  actionType  ModerationActionType
  when        DateTime // When the action occurred
  reason      String   // Reason for the action
  duration    String?  // Duration (for timeouts, temp bans, etc.)

  // Additional details
  channelId   String?  // Channel where action occurred
  messageId   String?  // Message that triggered action (if applicable)
  evidenceUrls Json     @default("[]") // Screenshot/evidence links stored as JSON

  // Status
  isActive    Boolean  @default(true) // For temporary actions
  expiresAt   DateTime? // When temporary action expires

  // Notes
  notes       String?  @db.Text // Additional notes or context

  // Relations
  member      MemberRecord @relation(fields: [memberId], references: [id], onDelete: Cascade)
  warning     Warning? @relation(fields: [warningId], references: [id], onDelete: SetNull)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([memberId])
  @@index([staffId])
  @@index([actionType])
  @@index([when])
  @@index([isActive])
  @@index([ticketId])
}

enum ModerationActionType {
  WARNING_ISSUED
  INFORMAL_WARNING_ISSUED
  TIMEOUT
  KICK
  BAN
  UNBAN
  WATCHLIST_ADDED
  WATCHLIST_REMOVED
  VERIFICATION_REVOKED
  VERIFICATION_GRANTED
  OTHER
}

// Mod on Call Rotation
model ModOnCall {
  id          String   @id @default(uuid())
  staffId     String   // Discord user ID
  weekStart   DateTime // Friday when rotation started
  weekEnd     DateTime // Next Friday
  isActive    Boolean  @default(true)

  // Stats
  ticketsClosed Int    @default(0)
  recordsLogged  Int    @default(0)

  createdAt   DateTime @default(now())

  @@index([isActive])
  @@index([weekStart])
}

// Verification-specific data (ID verification only)
// Note: VRChat verification is handled by Hephia Bot, not tracked in tickets
model VerificationTicket {
  id          String   @id @default(uuid())
  ticketId    String   @unique

  // Verification steps
  initialVerifierId String? // MemberRecord ID - Cutie Helper or Moderator who did initial
  initialVerifier   MemberRecord? @relation("InitialVerifier", fields: [initialVerifierId], references: [id], onDelete: SetNull)
  finalVerifierId   String? // MemberRecord ID - Moderator who closed (must be different)
  finalVerifier     MemberRecord? @relation("FinalVerifier", fields: [finalVerifierId], references: [id], onDelete: SetNull)

  // Status tracking
  idReceivedAt      DateTime?
  initialVerifiedAt DateTime?
  finalVerifiedAt   DateTime?

  // Reminders
  reminderCount     Int      @default(0)
  lastReminderAt    DateTime?

  ticket            Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([initialVerifierId])
  @@index([finalVerifierId])
}

// Event Report-specific data
model EventReportTicket {
  id          String   @id @default(uuid())
  ticketId    String   @unique

  // Event details
  eventName   String?
  eventDate   DateTime?
  eventHostId String?  // Discord user ID of event host

  // Report details
  reportedUserId String? // Discord user ID of reported member
  incidentType   String? // Type of incident

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([eventHostId])
  @@index([reportedUserId])
}

// Staff-Talk specific metadata (for tracking purpose)
model StaffTalkTicket {
  id          String   @id @default(uuid())
  ticketId    String   @unique

  // Purpose tracking
  purpose     String?  // "investigation", "warning", "punishment", "staff_applicant", "member_report", etc.
  isPunishmentTicket Boolean @default(false) // True if opened by staff for punishment

  // Related member (if applicable)
  targetMemberId String? // Discord user ID of member being investigated/warned

  ticket      Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([targetMemberId])
  @@index([isPunishmentTicket])
}

// Ticket Bot Settings (global bot configuration)
model TicketBotSettings {
  id          String   @id @default(uuid())
  guildId     String   @unique // Discord guild ID

  // Ticket limits
  maxTicketsPerUser Int @default(1) // Maximum tickets that can be opened at once per user

  // Language (for future i18n support)
  botLanguage String?  // Language code (e.g., "en", "fr")

  // User permissions
  allowUserCloseTickets Boolean @default(false) // Allow users to close tickets themselves
  userFeedbackEnabled Boolean @default(true) // User Feedback toggle

  // Panel channel
  panelChannelId String? // Channel ID which will host the panel and from which tickets will be opened

  // Transcript settings
  transcriptEnabled Boolean @default(true) // Enabling transcript (toggle)
  transcriptChannelId String? // Channel ID to log transcripts to
  sendTranscriptToUser Boolean @default(false) // Toggle send transcript to user
  sendTranscriptToParticipants Boolean @default(false) // Toggle send transcript to all participants
  sendTranscriptOnlyToMembersLeft Boolean @default(false) // If sendTranscriptToParticipants is on: send transcript only to members left in the ticket

  // Auto-close settings
  autoCloseEnabled Boolean @default(false) // Toggle auto close on/off (the whole system toggle)
  autoCloseOnUserLeaving Boolean @default(false) // Auto close on user leaving toggle
  autoCloseAfterNoResponse Boolean @default(false) // Close after X time of no response in a ticket (toggle)
  autoCloseAfterNoResponseMinutes Int? // Number of minutes for no response auto-close
  autoCloseAfterOpening Boolean @default(false) // Close after X time since ticket opening (toggle)
  autoCloseAfterOpeningMinutes Int? // Number of minutes for opening auto-close

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([guildId])
}

// Ticket Type Settings (configuration per ticket type)
model TicketTypeSettings {
  id          String   @id @default(uuid())
  guildId     String
  ticketType  TicketType

  // Transcript override (0: bot default, 1: true, 2: false)
  transcriptOverride Int @default(0)

  // Role mentions
  mentionRoleIds Json @default("[]") // Array of role IDs that will be pinged when the ticket is opened

  // Display settings
  name        String   // Name of the ticket type
  description String?  @db.Text // Description of the ticket type (for internally)

  // Naming scheme
  namingSchemeOverride String? // Naming scheme override + custom field

  // Button/UI settings
  buttonColor String?  // Button color (hex or Discord color)
  buttonText  String?  // Button text
  emojiEnabled Boolean @default(false) // Emoji toggle
  emoji       String?  // Emoji picker value

  // Images
  largeImageUrl String? // Large image URL (for embed)
  thumbnailImageUrl String? // Small preview image URL (thumbnail for embed)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  group       TicketGroupSettings? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  groupId     String?

  @@unique([guildId, ticketType])
  @@index([guildId])
  @@index([groupId])
}

// Ticket Group Settings (groups of ticket types, e.g., for select menus)
model TicketGroupSettings {
  id          String   @id @default(uuid())
  guildId     String
  name        String   // Group name
  description String?  @db.Text

  // Select menu settings
  useSelectMenu Boolean @default(false) // Toggle for select menu instead of dedicated buttons
  selectMenuPlaceholder String? // Select menu placeholder by default

  // Relations
  ticketTypes TicketTypeSettings[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([guildId])
}


